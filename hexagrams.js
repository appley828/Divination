// 八卦對應 (用於查找)
// 乾=111, 兌=110, 離=101, 震=100, 巽=011, 坎=010, 艮=001, 坤=000
const TRIGRAMS = {
    '111': '乾',
    '110': '兌',
    '101': '離',
    '100': '震',
    '011': '巽',
    '010': '坎',
    '001': '艮',
    '000': '坤'
};

// 64卦資料 [卦序, 卦名, 全名, 卦義]
// 索引格式: 下卦_上卦
const HEXAGRAMS = {
    // 乾下 (111)
    '111_111': [1, '乾', '乾為天', '剛健中正'],
    '111_110': [43, '夬', '澤天夬', '決而能和'],
    '111_101': [14, '大有', '火天大有', '順天依時'],
    '111_100': [34, '大壯', '雷天大壯', '壯勿妄動'],
    '111_011': [9, '小畜', '風天小畜', '蓄養待進'],
    '111_010': [5, '需', '水天需', '守正待機'],
    '111_001': [26, '大畜', '山天大畜', '止而不止'],
    '111_000': [11, '泰', '地天泰', '應時而變'],

    // 兌下 (110)
    '110_111': [10, '履', '天澤履', '腳踏實地'],
    '110_110': [58, '兌', '兌為澤', '剛內柔外'],
    '110_101': [38, '睽', '火澤睽', '異中求同'],
    '110_100': [54, '歸妹', '雷澤歸妹', '立家興業'],
    '110_011': [61, '中孚', '風澤中孚', '誠信立身'],
    '110_010': [60, '節', '水澤節', '萬物有節'],
    '110_001': [41, '損', '山澤損', '損益制衡'],
    '110_000': [19, '臨', '地澤臨', '教民保民'],

    // 離下 (101)
    '101_111': [13, '同人', '天火同人', '上下和同'],
    '101_110': [49, '革', '澤火革', '順天應人'],
    '101_101': [30, '離', '離為火', '附和依託'],
    '101_100': [55, '豐', '雷火豐', '日中則昃'],
    '101_011': [37, '家人', '風火家人', '誠威治業'],
    '101_010': [63, '既濟', '水火既濟', '盛極將衰'],
    '101_001': [22, '賁', '山火賁', '飾外揚質'],
    '101_000': [36, '明夷', '地火明夷', '晦而轉明'],

    // 震下 (100)
    '100_111': [25, '無妄', '天雷無妄', '無妄而得'],
    '100_110': [17, '隨', '澤雷隨', '隨時變通'],
    '100_101': [21, '噬嗑', '火雷噬嗑', '剛柔相濟'],
    '100_100': [51, '震', '震為雷', '臨危不亂'],
    '100_011': [42, '益', '風雷益', '損上益下'],
    '100_010': [3, '屯', '水雷屯', '萬物始生'],
    '100_001': [27, '頤', '山雷頤', '純正以養'],
    '100_000': [24, '復', '地雷復', '寓動於順'],

    // 巽下 (011)
    '011_111': [44, '姤', '天風姤', '天下有風'],
    '011_110': [28, '大過', '澤風大過', '非常行動'],
    '011_101': [50, '鼎', '火風鼎', '穩重圖變'],
    '011_100': [32, '恆', '雷風恆', '恆心有成'],
    '011_011': [57, '巽', '巽為風', '謙遜受益'],
    '011_010': [48, '井', '水風井', '求賢若渴'],
    '011_001': [18, '蠱', '山風蠱', '振疲起衰'],
    '011_000': [46, '升', '地風升', '積小成大'],

    // 坎下 (010)
    '010_111': [6, '訟', '天水訟', '慎爭戒訟'],
    '010_110': [47, '困', '澤水困', '困境求通'],
    '010_101': [64, '未濟', '火水未濟', '事業未竟'],
    '010_100': [40, '解', '雷水解', '柔道致治'],
    '010_011': [59, '渙', '風水渙', '拯救渙散'],
    '010_010': [29, '坎', '坎為水', '行險用險'],
    '010_001': [4, '蒙', '山水蒙', '啟蒙奮發'],
    '010_000': [7, '師', '地水師', '行險而順'],

    // 艮下 (001)
    '001_111': [33, '遯', '天山遯', '遁世救世'],
    '001_110': [31, '咸', '澤山咸', '相互感應'],
    '001_101': [56, '旅', '火山旅', '依義順時'],
    '001_100': [62, '小過', '雷山小過', '行動有度'],
    '001_011': [53, '漸', '風山漸', '漸進蓄德'],
    '001_010': [39, '蹇', '水山蹇', '險阻在前'],
    '001_001': [52, '艮', '艮為山', '動靜適時'],
    '001_000': [15, '謙', '地山謙', '內高外低'],

    // 坤下 (000)
    '000_111': [12, '否', '天地否', '不交不通'],
    '000_110': [45, '萃', '澤地萃', '薈萃聚集'],
    '000_101': [35, '晉', '火地晉', '求進發展'],
    '000_100': [16, '豫', '雷地豫', '順時依勢'],
    '000_011': [20, '觀', '風地觀', '觀下瞻上'],
    '000_010': [8, '比', '水地比', '誠信團結'],
    '000_001': [23, '剝', '山地剝', '順勢而止'],
    '000_000': [2, '坤', '坤為地', '柔順伸展']
};

// 根據六爻查找卦象
function getHexagram(lines) {
    // lines[0]是初爻(最下面), lines[5]是上爻(最上面)
    // 每個line是 {value: 6|7|8|9, isYang: boolean, isChanging: boolean}

    // 下卦 (初爻到三爻)
    const lowerTrigram = lines.slice(0, 3).map(l => l.isYang ? '1' : '0').join('');
    // 上卦 (四爻到上爻)
    const upperTrigram = lines.slice(3, 6).map(l => l.isYang ? '1' : '0').join('');

    const key = `${lowerTrigram}_${upperTrigram}`;
    return HEXAGRAMS[key];
}

// 獲取變卦 (如果有動爻的話)
function getChangedHexagram(lines) {
    const hasChanging = lines.some(l => l.isChanging);
    if (!hasChanging) return null;

    // 變卦：動爻變成相反
    const changedLines = lines.map(l => ({
        ...l,
        isYang: l.isChanging ? !l.isYang : l.isYang
    }));

    return getHexagram(changedLines);
}
